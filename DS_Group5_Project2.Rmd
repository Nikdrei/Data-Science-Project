---
title: "Introduction to Data Science - Project II"
author: "Team 5: Dreispiel Juan Nicole, Espinosa Robles Manuel, Motiani Sonam, Nieves Pérez Luisa Fernanda"
date: "today"
# date: "`r Sys.Date()`"
output:
  html_document:
    code_folding: hide
    number_sections: false
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
---


```{r}
knitr::opts_chunk$set(echo = TRUE)

#install.packages("easypackages")
easypackages::packages("data.table", "DT", "dplyr", "mgcv", "ggplot2", "RColorBrewer", "plotly", "parallel", "mltools", prompt = F)
```


```{r basic, include=F}
# use this function to conveniently load libraries and work smoothly with knitting
# can add quietly=T option to the require() function
# the loadPkg function essentially replaced/substituted two functions install.packages() and library() in one step.
loadPkg = function(x) { if (!require(x,character.only=T, quietly =T)) { install.packages(x,dep=T,repos="http://cran.us.r-project.org"); if(!require(x,character.only=T)) stop("Package not found") } }

# unload/detact package when done using it
unloadPkg = function(pkg, character.only = FALSE) { 
  if(!character.only) { pkg <- as.character(substitute(pkg)) } 
  search_item <- paste("package", pkg,sep = ":") 
  while(search_item %in% search()) { detach(search_item, unload = TRUE, character.only = TRUE) } 
}
```

```{r setup, include=FALSE}
# some of common options (and the defaults) are: 
# include=T, eval=T, echo=T, results='hide'/'asis'/'markup',..., collapse=F, warning=T, message=T, error=T, cache=T, fig.width=6, fig.height=4, fig.dim=c(6,4) #inches, fig.align='left'/'center','right', 
knitr::opts_chunk$set(warning = F, results = "markup", message = F)
# knitr::opts_chunk$set(warning = F, results = "hide", message = F)
# knitr::opts_chunk$set(include = F)
# knitr::opts_chunk$set(echo = TRUE)
options(scientific=T, digits = 3) 
# options(scipen=9, digits = 3) 
# ‘scipen’: integer. A penalty to be applied when deciding to print numeric values in fixed or exponential notation.  Positive values bias towards fixed and negative towards scientific notation: fixed notation will be preferred unless it is more than ‘scipen’ digits wider.
# use scipen=999 to prevent scientific notation at all times
```

```{r xkablesummary}
loadPkg("xtable")
loadPkg("kableExtra")
loadPkg("stringi")

xkabledply = function(modelsmmrytable, title="Table", digits = 4, pos="left", bso="striped", wide=FALSE) { 
  #' Combining base::summary, xtable, and kableExtra, to easily display model summary. 
  #' wrapper for the base::summary function on model objects
  #' Can also use as head for better display
  #' ELo 202004 GWU DATS
  #' version 1.2
  #' @param modelsmmrytable This can be a generic table, a model object such as lm(), or the summary of a model object summary(lm()) 
  #' @param title Title of table. 
  #' @param digits Number of digits to display
  #' @param pos Position of table, c("left","center","right") 
  #' @param bso bootstrap_options = c("basic", "striped", "bordered", "hover", "condensed", "responsive")
  #' @param wide print table in long (FALSE) format or wide (TRUE) format
  #' @return HTML table for display
  #' @examples
  #' library("xtable")
  #' library("kableExtra")
  #' xkabledply( df, title="Table testing", pos="left", bso="hover" )
  #' xkabledply( ISLR::Hitters[1:5,] )
  if (wide) { modelsmmrytable <- t(modelsmmrytable) }
  modelsmmrytable %>%
    xtable() %>% 
    kable(caption = title, digits = digits) %>%
    kable_styling(bootstrap_options = bso, full_width = FALSE, position = pos)
}

xkabledplyhead = function(df, rows=5, title="Head", digits = 4, pos="left", bso="striped") { 
  xkabledply(df[1:rows, ], title, digits, pos, bso, wide=FALSE)
}

xkabledplytail = function(df, rows=5, title="Tail", digits = 4, pos="left", bso="striped") { 
  trows = nrow(df)
  xkabledply(df[ (trows-rows+1) : trows, ], title, digits, pos, bso, wide=FALSE)
}

xkablesummary = function(df, title="Table: Statistics summary.", digits = 4, pos="left", bso="striped") { 
  #' Combining base::summary, xtable, and kableExtra, to easily display numeric variable summary of dataframes. 
  #' ELo 202004 GWU DATS
  #' version 1.2
  #' @param df The dataframe.
  #' @param title Title of table. 
  #' @param digits Number of digits to display
  #' @param pos Position of table, c("left","center","right") 
  #' @param bso bootstrap_options = c("basic", "striped", "bordered", "hover", "condensed", "responsive")
  #' @return The HTML summary table for display, or for knitr to process into other formats 
  #' @examples
  #' xkablesummary( faraway::ozone )
  #' xkablesummary( ISLR::Hitters, title="Five number summary", pos="left", bso="hover"  )
  
  s = summary(df) %>%
    apply( 2, function(x) stringr::str_remove_all(x,c("Min.\\s*:\\s*","1st Qu.\\s*:\\s*","Median\\s*:\\s*","Mean\\s*:\\s*","3rd Qu.\\s*:\\s*","Max.\\s*:\\s*")) ) %>% # replace all leading words
    apply( 2, function(x) stringr::str_trim(x, "right")) # trim trailing spaces left
  
  colnames(s) <- stringr::str_trim(colnames(s))
  
  if ( dim(s)[1] ==6 ) { rownames(s) <- c('Min','Q1','Median','Mean','Q3','Max') 
  } else if ( dim(s)[1] ==7 ) { rownames(s) <- c('Min','Q1','Median','Mean','Q3','Max','NA') }
  
  xkabledply(s, title=title, digits = digits, pos=pos, bso=bso )
}

xkablevif = function(model, title="VIFs of the model", digits = 3, pos="left", bso="striped", wide=TRUE) { 
  #' Combining faraway::vif, xtable, and kableExtra, to easily display numeric summary of VIFs for a model. 
  #' ELo 202004 GWU DATS
  #' version 1.2
  #' @param model The lm or compatible model object.
  #' @param title Title of table. 
  #' @param digits Number of digits to display
  #' @param pos Position of table, c("left","center","right") 
  #' @param bso bootstrap_options = c("basic", "striped", "bordered", "hover", "condensed", "responsive")
  #' @param wide print table in long (FALSE) format or wide (TRUE) format
  #' @return The HTML summary table of the VIFs for a model for display, or for knitr to process into other formats 
  #' @examples
  #' xkablevif( lm(Salary~Hits+RBI, data=ISLR::Hitters, wide=T ) )
  
  vifs = table( names(model$coefficients)[2:length(model$coefficients)] ) # remove intercept to set column names
  vifs[] = faraway::vif(model) # set the values
  if (wide) { vifs <- t(vifs) }
  xkabledply( vifs, title=title, digits = digits, pos=pos, bso=bso )
}
```

```{r outlierKD2}
# Fix outliers
outlierKD2 <- function(df, var, rm=FALSE, boxplt=FALSE, histogram=TRUE, qqplt=FALSE) { 
    #' Original outlierKD functino by By Klodian Dhana,
    #' https://www.r-bloggers.com/identify-describe-plot-and-remove-the-outliers-from-the-dataset/
    #' Modified to have third argument for removing outliers instead of interactive prompt, 
    #' and after removing outlier, original df will not be changed. The function returns the a df, 
    #' which can be saved as original df name if desired.
    #' Also added QQ-plot in the output, with options to show/hide boxplot, histogram, qqplot.
    #' Check outliers, and option to remove them, save as a new dataframe. 
    #' @param df The dataframe.
    #' @param var The variable in the dataframe to be checked for outliers
    #' @param rm Boolean. Whether to remove outliers or not.
    #' @param boxplt Boolean. Whether to show the boxplot, before and after outliers removed.
    #' @param histogram Boolean. Whether to show the histogram, before and after outliers removed.
    #' @param qqplt Boolean. Whether to show the qqplot, before and after outliers removed.
    #' @return The dataframe with outliers replaced by NA if rm==TRUE, or df if nothing changed
    #' @examples
    #' outlierKD2(mydf, height, FALSE, TRUE, TRUE, TRUE)
    #' mydf = outlierKD2(mydf, height, TRUE, TRUE, TRUE, TRUE)
    #' mydfnew = outlierKD2(mydf, height, TRUE)
    dt = df # duplicate the dataframe for potential alteration
    var_name <- eval(substitute(var),eval(dt))
    na1 <- sum(is.na(var_name))
    m1 <- mean(var_name, na.rm = T)
    par(mfrow=c(2, boxplt+histogram+qqplt), oma=c(0,0,3,0))
    if (qqplt) { 
      qqnorm(var_name, main = "With outliers")
      qqline(var_name)
    }
    if (histogram) { hist(var_name, main="With outliers", xlab=NA, ylab=NA) }
    if (boxplt) { boxplot(var_name, main="With outliers") }

    outlier <- boxplot.stats(var_name)$out
    mo <- mean(outlier)
    var_name <- ifelse(var_name %in% outlier, NA, var_name)
    if (qqplt) { 
      qqnorm(var_name, main = "Without outliers")
      qqline(var_name)
    }
    if (histogram) { hist(var_name, main="Without outliers", xlab=NA, ylab=NA) }
    if (boxplt) { boxplot(var_name, main="Without outliers") }

    title("Outlier Check", outer=TRUE)
    na2 <- sum(is.na(var_name))
    cat("Outliers identified:", na2 - na1, "\n")
    cat("Propotion (%) of outliers:", round((na2 - na1) / sum(!is.na(var_name))*100, 1), "\n")
    cat("Mean of the outliers:", round(mo, 2), "\n")
    m2 <- mean(var_name, na.rm = T)
    cat("Mean without removing outliers:", round(m1, 2), "\n")
    cat("Mean if we remove outliers:", round(m2, 2), "\n")
    
    # response <- readline(prompt="Do you want to remove outliers and to replace with NA? [yes/no]: ")
    # if(response == "y" | response == "yes"){
    if(rm){
        dt[as.character(substitute(var))] <- invisible(var_name)
        #assign(as.character(as.list(match.call())$dt), dt, envir = .GlobalEnv)
        cat("Outliers successfully removed", "\n")
        return(invisible(dt))
    } else {
        cat("Nothing changed", "\n")
        return(invisible(df))
    }
}
```


Our Data set consists of 54 variables with 3941 observations.
Upon closer inspection we can see that there are 17 variables related to Alcohol consuption, 16 variables regarding Cannabis use, 10 demographic descriptive variables, and 9 variables related to the individuals' psychological aptitudes during the covid-19 pandemic. 

```{r}
library(readr)
Substance_Use <- read_csv("DSPJ2Data.csv")
head(Substance_Use)
str(Substance_Use)

#stats_with function is so that we don't have to indvidually write all variables that start with prefix "CAN" or "ALC"
main_clean <- Substance_Use %>% select (AGEGRP, PHHLDSZC, IMMIGRNC, SEX, PMARSTC, PEMPSTC, PEDUC_LC, RURURB, STRESS, LS_05,  starts_with('ME'), starts_with('CAN'), starts_with('ALC'), PERS_WGT)

head(main_clean)
str(main_clean)

Alcohol <- subset(Substance_Use[10:26])
Cannabis <- subset(Substance_Use[27:42])
Pandemic_Attitudes <- subset(Substance_Use[2:9])
Demographics <- subset(Substance_Use[43:50])
```

###EDA

***Exploring demographic categories and mental health during the pandemic***

```{r}
#Employment and pandemic
cor.test(Substance_Use$PEMPSTC, Substance_Use$ME_10)
cor.test(Substance_Use$PEMPSTC, Substance_Use$ME_15)

#age and pandemic 
cor.test(Substance_Use$AGEGRP, Substance_Use$ME_10)
cor.test(Substance_Use$AGEGRP, Substance_Use$ME_15)

#Marital status and pandemic
cor.test(Substance_Use$PMARSTC, Substance_Use$ME_10)
cor.test(Substance_Use$PMARSTC, Substance_Use$ME_15)

#household size and pandemic
cor.test(Substance_Use$PHHLDSZC, Substance_Use$ME_10)
cor.test(Substance_Use$PHHLDSZC, Substance_Use$ME_15)

#Education Level and pandemic
cor.test(Substance_Use$PEDUC_LC, Substance_Use$ME_10)
cor.test(Substance_Use$PEDUC_LC, Substance_Use$ME_15)

#Sex and pandemic
cor.test(Substance_Use$SEX, Substance_Use$ME_10)
cor.test(Substance_Use$SEX, Substance_Use$ME_15)

#Rural/urban and pandemic
cor.test(Substance_Use$RURURB, Substance_Use$ME_10)
cor.test(Substance_Use$RURURB, Substance_Use$ME_15)

#immigration status and pandemic
cor.test(Substance_Use$IMMIGRNC, Substance_Use$ME_10)
cor.test(Substance_Use$IMMIGRNC, Substance_Use$ME_15)
```


##Alcohol Correlations

```{r}
Alcohol_correlations <- cor(Alcohol)
xkabledply(Alcohol_correlations)

```

***Alcohol and Mental Health during the pandemic***

Mental Health correlations
```{r}
#Isolation
cor.test(Substance_Use$ALC_20, Substance_Use$ME_30C)

#Mental Health
cor.test(Substance_Use$ALC_20, Substance_Use$ME_10)

#Satisfaction
cor.test(Substance_Use$ALC_20, Substance_Use$LS_05)

#stress
cor.test(Substance_Use$ALC_20, Substance_Use$ME_15)

#Social Support
cor.test(Substance_Use$ALC_20, Substance_Use$ME_20)

```

##Cannabis correlations

```{r}
Cannabis_correlations <- cor(Cannabis)
xkabledply(Cannabis_correlations)
```

***Cannabis and Mental Health during the pandemic***

Mental Health correlations
```{r}
#Isolation
cor.test(Substance_Use$CAN_15, Substance_Use$ME_30C)

#Mental Health
cor.test(Substance_Use$CAN_15, Substance_Use$ME_10)

#Satisfaction
cor.test(Substance_Use$CAN_15, Substance_Use$LS_05)

#stress
cor.test(Substance_Use$CAN_15, Substance_Use$ME_15)

#Social Support
cor.test(Substance_Use$CAN_15, Substance_Use$ME_20)
```

###Linear Regression Models

***Cannabis Model***
```{r}
cannabis_df <- read_csv("DSPJ2Data.csv")


# stats_with function is so that I don't have to indvidually write all variables that start with prefix "CAN" or "ALC"
cannabis_clean <- cannabis_df %>% select (AGEGRP, PHHLDSZC, IMMIGRNC, SEX, PMARSTC, MHDVMHI, STRESS, PERS_WGT, VERDATE, PEMPSTC, PEDUC_LC, starts_with('CAN'), starts_with('ALC'))

#Filter those who never used Canabis, not statued its variable 
#! mean not in 1, 99, so remove those and keep everything else 
cannabis_filtered <- cannabis_clean %>% filter(!CAN_05 %in% c(1,99))

str(cannabis_filtered)

frequency(cannabis_filtered$CAN_05)

#Next Question, what should be our response variables?
  #Example: Let's say we want to model on CAN_15 (Increased, Decreased, NA, Stayed about Same). Since this is not continuous or binary, we have to be careful
  #https://blog.exploratory.io/filter-data-with-dplyr-76cf5f1a258e

#Binary - LM
#For experiement, removing non-applicable and stay same from analysis and not stated
frequency(cannabis_filtered$CAN_15)


cannabis_inc <- cannabis_filtered %>% filter(!CAN_15 %in% c(9))
cannabis_inc  <- cannabis_inc %>% mutate(CAN_15_Revised = as.numeric(if_else(CAN_15 == 1,"1","0")), Employed = as.numeric(if_else(PEMPSTC == 4,"0","1")))
cannabis_inc <- cannabis_inc %>% select(-c(CAN_15))

cannabis_dec <- cannabis_filtered %>% filter(!CAN_15 %in% c(9))
cannabis_dec  <- cannabis_dec %>% mutate(CAN_15_Revised = as.numeric(if_else(CAN_15 == 2,"1","0")), Employed = as.numeric(if_else(PEMPSTC == 4,"0","1")))
cannabis_dec <- cannabis_dec %>% select(-c(CAN_15))

```


```{r}
lmCAN <- glm(CAN_15_Revised ~ SEX + AGEGRP + PMARSTC + PEDUC_LC + Employed + PHHLDSZC + IMMIGRNC, data = cannabis_inc, weights = PERS_WGT)
summary(lmCAN)

library(ggiraphExtra)
library(plyr)
library(ggiraph)

modCAN <- glm(CAN_15_Revised ~ PEDUC_LC + Employed + PHHLDSZC, data = cannabis_inc, family = binomial)
ggPredict(modCAN,se=TRUE,interactive=TRUE)


```

***ALcohol Model***

```{r}
#Filter those who dont drink, not statued its variable 
#! mean not in 1, 99, so remove those and keep everything else 
alcohol_filtered <- main_clean %>% filter(!ALC_05 %in% c(1,99))

str(alcohol_filtered)

frequency(alcohol_filtered$ALC_05)

#Next Question, what should be our response variables?
  #Example: Let's say we want to model on ALC_10C (Increased, Decreased, NA, Stayed about Same). Since this is not continuous or binary, we have to be careful
  #https://blog.exploratory.io/filter-data-with-dplyr-76cf5f1a258e

#Binary - LM
#For experiement, removing non-applicable and stay same from analysis and not stated
frequency(alcohol_filtered$ALC_20)


alcohol_inc <- alcohol_filtered %>% filter(!ALC_20 %in% c(9))
alcohol_inc  <- alcohol_inc %>% mutate(ALC_20_Revised = as.numeric(if_else(ALC_20 == 1,"1","0")), Employed = as.numeric(if_else(PEMPSTC == 4,"0","1")))
alcohol_inc <- alcohol_inc %>% select(-c(ALC_20))

alcohol_dec <- alcohol_filtered %>% filter(!ALC_20 %in% c(9))
alcohol_dec <- alcohol_dec %>% mutate(ALC_20_Revised = as.numeric(if_else(ALC_20 == 2,"1","0")), Employed = as.numeric(if_else(PEMPSTC == 4,"0","1")))
alcohol_dec <- alcohol_dec %>% select(-c(ALC_20))


```


```{r}
lmALC <- glm(ALC_20_Revised ~ SEX + AGEGRP + PMARSTC + PEDUC_LC + Employed + PHHLDSZC + IMMIGRNC, data = cannabis_inc, weights = PERS_WGT)
summary(lmALC)

modALC <- glm(ALC_20_Revised ~ SEX + AGEGRP + PMARSTC + PEDUC_LC + Employed + PHHLDSZC + IMMIGRNC, data = alcohol_inc,family = binomial)
ggPredict(modALC,se=TRUE,interactive=TRUE)
```

###Feature Selection
***ALcohol***
```{r, results='markup'}
library(jtools)
library("leaps")
reg.data.alc <- regsubsets(ALC_20_Revised ~ SEX + AGEGRP + PMARSTC + PEDUC_LC + Employed + PHHLDSZC + IMMIGRNC, data = alcohol_inc,
nbest = 2,
nvmax = NULL,
force.in = NULL, force.out = NULL,
method = "exhaustive")

plot(reg.data.acl, scale = "adjr2", main = "Adjusted R^2")
plot(reg.data.acl, scale = "bic", main = "BIC")
plot(reg.data.alc, scale = "Cp", main = "Cp")


summary.reg <- summary(reg.data.alc)
as.data.frame(summary.reg$outmat)
which.max(summary.reg$adjr2)

FSALC <- lm((ALC_20_Revised ~ SEX + AGEGRP + PMARSTC + PEDUC_LC + Employed + PHHLDSZC + IMMIGRNC, data = alcohol_inc)
summary(FSALC)
summ(FSALC)
vif(FSALC)
```

```{r}
library(ggplot2)
library(GGally)

pairs(Alcohol, col = "red", pch = 1, main = "Alcohol Pairs Plot")

ggpairs(Alcohol, title = "Alcohol ggpairs Plot")

loadPkg(psych)
pairs.panels(Alcohol[,-5], 
             method = "pearson", # correlation method
             hist.col = "#00AFBB", # set histogram color, can use "#22AFBB", "red",
             density = TRUE,  # show density plots
             ellipses = TRUE # show correlation ellipses
             )

```

***Cannabis***
```{r, results='markup'}
reg.data.can <- regsubsets(CAN_15_Revised ~ PEDUC_LC + Employed + PHHLDSZC, data = cannabis_inc, 
nbest = 2,
nvmax = NULL,
force.in = NULL, force.out = NULL,
method = "exhaustive")

plot(reg.data.can, scale = "adjr2", main = "Adjusted R^2")
plot(reg.data.can, scale = "bic", main = "BIC")
plot(reg.data.can, scale = "Cp", main = "Cp")

summary.reg.can <- summary(reg.data.can)
as.data.frame(summary.reg.can$outmat)
which.max(summary.reg.can$adjr2)


FSCAN <- lm(CAN_15_Revised ~ SEX + AGEGRP + PMARSTC + PEDUC_LC + Employed + PHHLDSZC + IMMIGRNC, data = cannabis_inc)
summary(FSCAN)
summ(FSCAN)
vif(FSCAN)

```

```{r}
library(ggplot2)
library(GGally)

pairs(Cannabis, col = "red", pch = 1, main = "Cannabis Pairs Plot")

ggpairs(Cannabis, title = "Cannabis ggpairs Plot")

loadPkg(psych)
pairs.panels(Cannabis[,-5], 
             method = "pearson", # correlation method
             hist.col = "#00AFBB", # set histogram color, can use "#22AFBB", "red",
             density = TRUE,  # show density plots
             ellipses = TRUE # show correlation ellipses
             )
```

###PCR Models

***Cannabis PCR***
```{r}
library(olsrr)
library(caret)

pcrcan <- prcomp(Cannabis)
xkabledply(pcrcan)

biplot(pcrcan, c(1,2), scale=0, xlim=c(-20,20), ylim=c(-20,20))

```

***Cannabis PVE***
```{r}
library(lattice)
library(grid)
library(gridExtra)

PVECAN <- pcrcan$values / sum(pcrcan$values)
n <- length(PVECAN)

PVECANplot <- qplot(c(1:n), PVECAN) +
geom_line() +
xlab("Principal Component") +
ylab("PVECAN") +
ggtitle("Scree Plot") +
ylim(0,1)

cumPVECAN <- qplot(c(1:n), cumsum(PVECAN)) +
geom_line() +
xlab("Principal Component") +
ylab(NULL) +
ggtitle("Cumulative Scree Plot") +
ylim(0,1)

grid.arrange(PVECANplot, cumPVECAN, ncol = 9)
```

***Alcohol PCR***
```{r}
pcralc <- prcomp(Alcohol)
xkabledply(pcralc)

biplot(pcralc, c(1,2), scale=0, xlim=c(-20,20), ylim=c(-20,20))
biplot(pcralc, c(1,3), scale=0, xlim=c(-20,20), ylim=c(-20,20))
biplot(pcralc, c(1,4), scale=0, xlim=c(-20,20), ylim=c(-20,20))
biplot(pcralc, c(1,2), scale=0, xlim=c(-20,20), ylim=c(-20,20))
```

***ALcohol PVE***
```{r}
library(lattice)
library(grid)
library(gridExtra)

PVEALC <- pcralc$values / sum(pcralc$values)
n <- length(PVEALC)

PVEALCplot <- qplot(c(1:n), PVEALC) +
geom_line() +
xlab("Principal Component") +
ylab("PVEALC") +
ggtitle("Scree Plot") +
ylim(0,1)

cumPVEALC <- qplot(c(1:n), cumsum(PVEALC)) +
geom_line() +
xlab("Principal Component") +
ylab(NULL) +
ggtitle("Cumulative Scree Plot") +
ylim(0,1)

grid.arrange(PVEALCplot, cumPVEALC, ncol = 23)
